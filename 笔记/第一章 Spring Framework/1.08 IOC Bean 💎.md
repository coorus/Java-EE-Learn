# æ·±å…¥IOC [Bean](../æ¦‚å¿µ/Bean.md)

![](../Source/attachments/sinon_1.png)
## IOCå®¹å™¨åˆ›å»ºæ–¹å¼
1. é€šè¿‡ XML é…ç½®
	- ä½¿ç”¨ `ClassPathXmlApplicationContext`ã€‚
2. é€šè¿‡é…ç½®ç±»
	- ä½¿ç”¨ `@Configuration` æ³¨è§£ã€‚
	- `AnnotationConfigApplicationContext`ã€‚
3. Spring Boot æ–¹å¼
	* ä½¿ç”¨ `ConfigurableApplicationContext`ã€‚

ğŸŒŸ ä¸åŒç±»å‹çš„å®¹å™¨ä½¿ç”¨ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼[Bean](../æ¦‚å¿µ/Bean.md)
## Bean
### æ¦‚å¿µ
* Bean æ˜¯è¢« Spring IOC ç®¡ç†çš„å¯¹è±¡ã€‚
### åˆ›å»ºæ–¹å¼
  * é€šè¿‡ XML é…ç½® `<bean>` æ ‡ç­¾ã€‚
  * ä½¿ç”¨ `@Component` æ³¨è§£ã€‚
### åˆ›å»ºè¿‡ç¨‹
1. IOCè¯»å–`<bean>`æ ‡ç­¾æˆ–@Component
2. å®¹å™¨åˆ›å»º Bean å¯¹è±¡ï¼Œå¹¶æ”¾åˆ°è‡ªèº«ä¸­è¿›è¡Œç®¡ç†ï¼ˆæ§åˆ¶åè½¬ï¼‰ã€‚
3. è®¾ç½® Bean å¯¹è±¡é—´çš„ä¾èµ–å…³ç³»ï¼ˆä¾èµ–æ³¨å…¥ï¼‰ã€‚
![QQ_1724751057783](attachments/QQ_1724751057783.png)

ğŸŒŸ æ§åˆ¶åè½¬ï¼šå¯¹è±¡åˆ›å»ºæƒåŠ›è¢«åè½¬ã€‚
ğŸŒŸ ä¾èµ–æ³¨å…¥ï¼šå°†ä¸€ä¸ªå¯¹è±¡æ”¾å…¥å¦ä¸€ä¸ªå¯¹è±¡ã€‚
### æ³¨è§£è¯¦è§£
- **`@Component`**: è¡¨ç¤ºè¦è¢« IOC ç®¡ç†<span style="background:#fff88f">ï¼ˆæ”¾åœ¨ç±»ä¸Šï¼‰</span>ã€‚ç±»åå¼€å¤´å˜æˆå°å†™æ˜¯ Bean çš„ nameã€‚
- è¡ç”Ÿæ³¨è§£ï¼ˆæœ¬è´¨ä¸Šä¹Ÿæ˜¯ `@Component`ï¼‰ï¼š
	- `@Configuration`: é…ç½®ç±»ï¼Œä»£æ›¿ XML é…ç½®æ–‡ä»¶ã€‚
	- `@Service`: è¡¨ç¤ºæœåŠ¡å±‚ã€‚
	- `@Repository`: è¡¨ç¤ºæŒä¹…å±‚ã€‚
## `@Bean` æ³¨è§£
åŠŸèƒ½å’Œ `@Component` ä¸€æ ·ï¼Œè¡¨ç¤ºè¦è¢« IOC ç®¡ç†ï¼Œä½†ä½¿ç”¨æ–¹å¼ä¸åŒã€‚
### ä½¿ç”¨æ–¹å¼
1. åœ¨ `@Configuration` é…ç½®ç±»ä¸­ä½¿ç”¨ã€‚
2. @Beanè¦æ”¾åœ¨<span style="background:#fff88f">æ–¹æ³•ä¸Šï¼ˆæ–¹æ³•åå°±æ˜¯beançš„nameï¼‰</span>
```java
@Configuration
public class Config {
	@Bean
	public IEngine engine3() {
		return new Engine3();
	}
}
```

### è§£å†³@Componentçš„ä¸è¶³
@Componentå¿…é¡»å†™åœ¨ç±»ä¸Šï¼Œå¦‚æœæ˜¯ç¬¬ä¸‰æ–¹åŒ…æˆ‘ä»¬<span style="background:#fff88f">æ— æ³•åœ¨ç±»ä¸Šæ·»åŠ è¯¥æ³¨è§£ï¼Œæ— æ³•è‡ªå®šä¹‰åˆå§‹åŒ–è¿‡ç¨‹</span>
#### ç¤ºä¾‹åœºæ™¯ï¼šåˆ›å»ºä¸€ä¸ªåˆå§‹å€¼ä¸º {1, 2, 3} çš„ `ArrayList`
```java
@Configuration
public class Config1 {
    @Bean
    public List<Integer> numbers() {
        List<Integer> res = new ArrayList<>();
        res.add(1);
        res.add(2);
        res.add(3);
        return res;
    }
}
```
####  ç»ƒä¹ ï¼šå°†ç”Ÿäº§ä¸€æ‰¹æ±½è½¦ä» `@Component` å…¨éƒ¨æ”¹ä¸º `@Bean`
```java
@Configuration
public class Config {
    @Bean
    public IEngine engine() {
        return new Engine1();
    }

    @Bean
    public Car car(IEngine engine) {
        return new Car(engine);
    }
}
```
##### é—®é¢˜
1. ç›´æ¥è°ƒç”¨ `engine()` å¾—åˆ°çš„å¯¹è±¡å’Œ IOC ç®¡ç†çš„ `engine` å¯¹è±¡æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ
2. å¦‚æœå¤šè°ƒç”¨å‡ æ¬¡ `engine()`ï¼Œå®ƒä»¬è¿”å›çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªå—ï¼Ÿ
	* ğŸŒŸ<span style="background:#fff88f"> åœ¨ `@Configuration` ä¸‹çš„ `@Bean` æ–¹æ³•</span>ï¼Œè¿”å›å¯¹è±¡å°±æ˜¯ IOC æ‰€ç®¡ç†çš„å¯¹è±¡ï¼Œé»˜è®¤æƒ…å†µä¸‹å¤šæ¬¡è°ƒç”¨æ–¹æ³•éƒ½<span style="background:#fff88f">è¿”å›åŒä¸€å¯¹è±¡ã€‚</span>
##### ç»ƒä¹ ç®€å†™ï¼šå‚æ•°è‡ªåŠ¨è£…é…
```java
//Config.java
@Configuration  
public class Config {  
    @Bean  
    public IEngine engineA() {  
        return new EngineA();  
    }  
    @Bean  
    public IEngine engineB() {  
        return new EngineB();  
    }  
}
```
```java
//Config1.java
@Configuration  
public class Config1 {  
    @Bean  
    public Car car(@Qualifier("engineB") IEngine engine) {  
        return new Car(engine);  
    }  
}
```
```java
//EngineA.java
public class EngineA implements IEngine{  
    @Override  
    public String toString() {  
        return "EngineA{}";  
    }  
}
```
```java
//EngineB.java
public class EngineB implements IEngine{  
    @Override  
    public String toString() {  
        return "EngineB{}";  
    }  
}
```
```java
//Section18SpringBootApplication.java
@SpringBootApplication  
public class Section18SpringBootApplication {  
  
    public static void main(String[] args) {  
        //ConfigurableApplicationContext ioc = SpringApplication.run(Section18SpringBootApplication.class);  
  
        AnnotationConfigApplicationContext ioc = new AnnotationConfigApplicationContext(Config.class, Config1.class);  
  
        Car car = ioc.getBean(Car.class);  
        car.showEngine();  
  
        EngineB iEngine = ioc.getBean(EngineB.class);  
        System.out.println(iEngine);  
    }  
}
```
#### æ³¨æ„äº‹é¡¹
- åªæœ‰è¢« IOC ç®¡ç†çš„å¯¹è±¡æ‰èƒ½å‚æ•°è‡ªåŠ¨è£…é…ã€‚
- å‚æ•°è£…é…ä¸ Bean çš„å£°æ˜é¡ºåºæ— å…³ï¼ŒSpring ä¼šè§£æä¾èµ–å…³ç³»ï¼Œè‡ªå·±æ§åˆ¶é¡ºåºã€‚
- æ‰©å±•
	- åœ¨åŒä¸€é…ç½®ç±»ä¸­é¡ºåºæ— æ‰€è°“ã€‚
	- åœ¨ä¸åŒé…ç½®ç±»ä¸­é¡ºåºä¹Ÿæ— æ‰€è°“ã€‚
##### `AnnotationConfigApplicationContext()`å’Œ`SpringApplication.run()`ä¸¤ç§IOCé…ç½®æ–¹å¼çš„çš„åŒºåˆ«
```java
ConfigurableApplicationContext ioc = SpringApplication.run(Section18SpringBootApplication.class);  
  
AnnotationConfigApplicationContext ioc = new AnnotationConfigApplicationContext(Config.class, Config1.class);
```
## `@Import` æ³¨è§£
è¡¨ç¤ºè¦è¢« IOC ç®¡ç†ã€‚
###  ä½¿ç”¨æ–¹å¼
```java
//Config.java
@Configuration  
@Import({Car.class, EngineA.class, EngineB.class})  
public class Config {  }
```
```java
//Car.java
public class Car {  
    @Autowired  
    @Qualifier("engineA")  
    private IEngine iEngine;  
    public void showEngine() {  
        System.out.println(iEngine);  
    }  
}
```

### æ„é€  Bean è°ƒç”¨å“ªä¸ªæ„é€ æ–¹æ³•ï¼Ÿ
#### **`@Component` / `@Import`**
1. æœ‰é»˜è®¤æ„é€ æ—¶è°ƒç”¨é»˜è®¤æ„é€ ã€‚
```java
private @Qualifier("engineA") IEngine iEngine = private IEngine engineA
```
2. åªæœ‰ä¸€ä¸ªæœ‰å‚æ„é€ æ—¶è°ƒç”¨è¯¥æœ‰å‚æ„é€ å¹¶è¿›è¡Œå‚æ•°è£…é…ã€‚
```java
@Component  
public class Car {  
	private IEngine iEngine;  
  
	public void showEngine() {  
		System.out.println(iEngine);  
	}  
  
	public Car(IEngine engineB) {  
		this.iEngine = engineB;  //æŒ‰ç…§å˜é‡åè¿›è¡ŒåŒ¹é…
		System.out.println("ä¸€ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•");  
	}  
}
```
3. å¤šä¸ªæœ‰å‚æ„é€ ä¸”æ²¡æœ‰æ— å‚æ„é€ ï¼Œä¼šæŠ¥é”™ã€‚
#### **`@Bean`**ï¼šå¯ä»¥åœ¨æ–¹æ³•ä¸­è‡ªç”±é€‰æ‹©æ„é€ ã€‚
```java
@Component
public class Car {
	private IEngine iEngine;

	public void showEngine() {
		System.out.println(iEngine);
	}

	public Car(IEngine engineB) {
		this.iEngine = engineB;//Match according to the variable name
		System.out.println("ä¸€ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•");
	}
}
```
## `@Order` æ³¨è§£ / å®ç° `Ordered` æ¥å£
- å½“æœ‰å¤šä¸ªåŒç±»å‹çš„ Beanï¼Œç”¨ `List` æ¥æ”¶æ—¶ï¼Œé€šè¿‡ `@Order` æ³¨è§£æ”¹å˜ Bean åœ¨ `List` ä¸­çš„é¡ºåºï¼Œ<span style="background:#fff88f">å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</span>
### Orderæ³¨è§£
```java
// Computer.java  
@AllArgsConstructor  
public class Computer {  
    private ICpu iCpu;  
    private List<IMemory> iMemory;  
}
```
> `@AllArgsConstructor`å…¨å‚æ„é€ é‡Œé¢ä¸èƒ½åŠ å…¥æ³¨è§£
```java
// Config.java  
@Configuration  
public class Config {  
    @Bean  
    public ICpu cpuA() {  
        return new CpuA();  
    }  
    @Bean  
    public ICpu cpuB() {  
        return new CpuB();  
    }  
    @Bean @Order(0)  
    public IMemory memoryA() {  
        return new MemoryA();  
    }  
    @Bean @Order(1)  
    public IMemory memoryB() {  
        return new MemoryB();  
    }  
    @Bean  
    public Computer computer(ICpu cpuA, List<IMemory> memory) {  
        return new Computer(cpuA, memory);  
    }  
}
```
### å®ç°Orderedæ¥å£
```java
// MemoryA.java  
@Component  
public class MemoryA implements IMemory, Ordered {  
    @Override  
    public int getOrder() {  
        return 2;  
    }  
}
```
## `@Lazy` æ³¨è§£
- æ™®é€š Bean åœ¨ IOC åŠ è½½æ—¶å·²ç»åˆ›å»ºã€‚
- åŠ ä¸Š `@Lazy` çš„ Bean åªæœ‰åœ¨ä½¿ç”¨æ—¶ï¼ˆè‡ªåŠ¨æ³¨å…¥/getBeanï¼‰æ‰åˆ›å»ºã€‚
```java
// Config.java  
@Configuration  
public class Config {  
    @Bean  
    @Lazy    public ICpu cpuA() {  
        return new CpuA();  
    }  
    @Bean  
    public ICpu cpuB() {  
        return new CpuB();  
    }  
    @Bean  
    public IMemory memoryA() {  
        return new MemoryA();  
    }  
    @Bean  
    public IMemory memoryB() {  
        return new MemoryB();  
    }  
    @Bean  
    @Lazy    public Computer computer(ICpu cpuA, List<IMemory> memory) {  
        return new Computer(cpuA, memory);  
    }  
}
```
### æ‡’åŠ è½½
- `cpuA` å’Œ `computer` æ‡’åŠ è½½ï¼Œé»˜è®¤ä¸åˆ›å»º Beanã€‚
- å½“è°ƒç”¨ `ioc.getBean(Computer.class)` æ—¶æ‰ä¼šåˆ›å»º `computer`ï¼›
- åˆå› ä¸ºåˆ›å»ºcomputeréœ€è¦æ³¨å…¥cpuAï¼Œæ‰€ä»¥åˆ›å»ºcpuAæ‰§è¡Œé¡ºåºgetBean -> cpuA -> computer
##### æ‡’åŠ è½½çš„ä¼˜åŠ¿
ğŸŒŸ æ‡’åŠ è½½å¯ä»¥æé«˜Springåº”ç”¨å¯åŠ¨é€Ÿåº¦ï¼Œé¡¹ç›®ä¸­beanä¼šéå¸¸å¤šï¼Œå¦‚æœéƒ½åœ¨å¯åŠ¨æ—¶åˆ›å»ºå¾ˆè€—æ—¶ï¼Œä½¿ç”¨æ—¶å†åˆ›å»ºæ›´åˆç†
## `@Scope` æ³¨è§£
è®¾ç½® Bean çš„ä½œç”¨åŸŸï¼Œæœ‰ä¸¤ç§ç±»å‹ï¼š
- `singleton`ï¼ˆé»˜è®¤ï¼Œæ•´ä¸ªåº”ç”¨ä¸­åªä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚
- `prototype`ï¼ˆæ¯æ¬¡è·å– Bean æ—¶è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼‰ã€‚
```java
//Config.java
@Configuration
public class Config {
    @Bean
    public ICpu cpuA() {
        return new CpuA();
    }

    @Bean
    public IMemory memoryA() {
        return new MemoryA();
    }

    @Bean
    public IMemory memoryB() {
        return new MemoryB();
    }

    @Bean
    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    public Computer computer(ICpu cpuA, List<IMemory> memory) {
        return new Computer(cpuA, memory);
    }
}
```
```java

//Main.java
public static void main(String[] args) {
    ConfigurableApplicationContext ioc = SpringApplication.run(SpringTestApplication.class, args);
    Computer com1 = ioc.getBean(Computer.class);
    Computer com2 = ioc.getBean(Computer.class);
}
```
- **å•ä¾‹**ï¼šæ›´åŠ èŠ‚çœå†…å­˜ã€‚
- **å¤šä¾‹**ï¼šå¦‚æ¯è¾†æ±½è½¦éƒ½è¦ä¸€ä¸ªå‘åŠ¨æœºï¼Œè¿™æ—¶å‘åŠ¨æœºå°±ä¸èƒ½å•ä¾‹ã€‚
---